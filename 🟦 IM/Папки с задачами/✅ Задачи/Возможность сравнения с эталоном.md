Как выглядит вопрос:
>Я помогаю коллегам из КЭПТ внедрять ПО Proceset для Зарубежнефть.  
> 
У нас есть вопрос, касающийся темы в subj.  
Столкнулись с проблемой использования отчета по сравнению с эталоном.   
Так как в используемом эталоне задаются переходы между шагами процесса - не получается с помощью предложенного отчета найти кейсы которые удовлетворяют эталону с точки зрения наличия обязательных шагов. Поясню на примере. Предположим, что у меня в процессе есть шаги: А, Б, В, Г которые должны обязательно быть и должны располагаться в такой последовательности. Но между ними могут быть а могут отсутствовать ряд дополнительных шагов, которые не являются проблемными, например, А, Б, Д, Ж, В, Г. Такой кейс для нас - ОК. Но так как мы задаем переходы между шагами - такой кейс будет "плохим".  
Что вы можете порекомендовать для выявления соответствия эталону с учетом описанной выше специфики?

**Ответ**

Для того, чтобы составить идеальную модель необходимо поиграться с настройками опциональности, где обязательными указать те шаги, которые нам нужны — (А, Б, В, Г), а шаги, по типу "Ж" - оставить опциональными в том же месте, как хотели изначально.

Кейс будет плохим или хорошим в зависимости от настроек эталона.

> не получается с помощью предложенного отчета найти кейсы которые удовлетворяют эталону с точки зрения наличия обязательных шагов

Потому что данный инструмент не предназначен для этого. Сутью данного инструмента является поиск тех мест процесса, которые отличаются от эталонного. 
Для того, чтобы найти "эталонный" кейс предлагаю воспользоваться страницей отчета "Карта процесса", которая позволяет нам с помощью фильтров визуализировать только те кейсы, которые нам нужны. 

Если клиент хочет, чтобы между выбранными действиями внутри сценария могли попадаться любые другие действия, то на данный момент такого функционала нет. Выход к этому можно придумать такой:
* С помощью скрипта или BI оставить только те варианты протекания сценария, которые будут содержать выбранные действия, как основные
* Позволить выводить любые другие действия между выбранными
* Красиво упаковать это в новую страницу, например

Регулярка может выглядеть так:

```regexp
Действие 1[\S\s\n]*?Действие 2[\S\s\n]*?Действие 3
```

При этом все это можно собрать с помощью JS блока, например.

Если "накидать" запрос в _DBeawer_, то получится нечто подобное:
```sql
SELECT 
	arrayStringConcat(strings_array, '[\s\S\n]*?') AS regexp_result
FROM (
	SELECT 
		splitByString('\n', output_data) AS strings_array
	FROM (
		SELECT scenario
		FROM scenario_table
		WHERE scenario_id = 89520727211
	)
)
```

При этом удалось написать скрипт, который сможет оставить для фильтрации только те сценарии, которые удовлетворяют сформированному эталону. Скрипт состоит из двух блоков:
1. Этот блок нужен для того, чтобы сформировать регулярное выражение:
```sql
select 
  '^' || arrayStringConcat(array_data, '[\s\S\n]*?') as regExp_expression
from (
  select groupArray(curr_event) as array_data
  from (
    select curr_event, next_event
    from reference
    where is_optional = 1
    order by number 
  )
)
```

2. Далее формируется таблица, по которой мы сможем фильтроваться и оставлять на карте только тот сценарий, который составлен по модели, которую пользователь составил самостоятельно
```sql
create or replace table regexp_filtering
engine = MergeTree
order by tuple()

as

select 
  arrayStringConcat(array_events, '\n') as scenario,
  id_variant
from variants 
where match(scenario, ${a2.regExp_expression})
```

**Ответ пользователю**

К сожалению, текущий отчет не позволяет найти кейсы, которые удовлетворяют эталону с точки зрения обязательных шагов. Это потому, что инструмент предназначен для поиска отклонений процесса от эталонного, а не для поиска точных совпадений.
Чтобы найти идеальный кейс, я рекомендую использовать страницу отчета "Карта процесса", которая с помощью фильтров позволяет визуализировать эталонный вариант протекания процесса.
Если вы хотите получить все "эталонные" варианты протекания процесса, то предлагаю использовать скрипт (*этот скрипт будет приложен в закрепленных файлах*)
 Если более подробно рассмотреть логику выполнения скрипта, то она заключается в том, чтобы создать регулярное выражение, на основании которого в промежуточную таблицу запишутся только те "сценарии", которые удовлетворяют "эталонному".

**Ответ 2**

Текущий отчет не позволяет найти кейсы, которые удовлетворяют эталону с точки зрения обязательных шагов, так как инструмент предназначен для поиска конкретных отклонений, а не последовательности действий.

Чтобы найти последовательность действий, которую вы считаете эталонной, я рекомендую использовать страницу отчета "Проверка соответствия", которая с помощью фильтров позволяет визуализировать выбранный вами вариант протекания процесса.  
Если вы хотите получить все "эталонные" варианты протекания процесса, то предлагаю использовать скрипт (_этот скрипт будет приложен в закрепленных файлах_). Данный скрипт позволяет создать промежуточную таблицу, по которой можно будет визуализировать только те сценарии, которые удовлетворяют эталонному. При этом необходимо добавить на страницу дашборда компонент "фильтр" по новой таблице.  

Если более подробно рассмотреть логику выполнения скрипта, то она заключается в том, чтобы создать регулярное выражение, на основании которого в промежуточную таблицу запишутся только те "сценарии", которые удовлетворяют "эталонному".
В это регулярное выражение, в качестве обязательных действий, попадают только те, которые пользователь обозначил, как обязательные.