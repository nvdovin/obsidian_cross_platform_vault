---
Owner: Nikita Vdovin
tags:
  - DT
  - Onboarding
---
# Что такое оконные функции

Оконные функции (window functions) в SQL — это мощный инструмент, который позволяет выполнять вычисления над набором строк, связанных с текущей строкой. Эти функции работают с “окном” данных, которое определяется как группа строк, соседних с текущей строкой или связанных с ней каким-либо другим образом.

Оконные функции в SQL предоставляют следующие возможности:

1. **Агрегация данных**: Вычисление агрегатных значений (например, суммы, среднего, максимума, минимума) не только для всей выборки, но и для определенного “окна” данных.
2. **Ранг и оконные функции**: Определение ранга строк в зависимости от значений в определенных столбцах. Например, можно найти ранг продавца по объему продаж или ранг продукта по количеству заказов.
3. **Смещение данных**: Получение значений из предыдущих или следующих строк в рамках окна. Это может быть полезно для анализа временных рядов или для вычисления разницы между соседними строками.
4. **Разделение данных**: Оконные функции позволяют разделять данные на группы (окна) на основе определенных критериев, что упрощает анализ и обработку данных.

Синтаксис оконных функций в SQL обычно выглядит следующим образом:

```SQL
SELECT function_name(arguments) OVER (
    [PARTITION BY partition_expression]
    [ORDER BY order_expression [ASC | DESC]]
    [ROWS | RANGE frame_start [frame_exclusion] ...]
)
FROM table_name;
```

- `function_name`: Имя оконной функции (например, SUM, AVG, ROW_NUMBER, LAG, LEAD и т.д.).
- `OVER`: Ключевое слово, указывающее на начало определения окна.
- `PARTITION BY`: Определяет, как разделить данные на группы (окна).
- `ORDER BY`: Указывает порядок сортировки строк в рамках каждого окна.
- `ROWS | RANGE`: Определяет, как определять границы окна (по строкам или по значениям).
- `frame_start` и `frame_exclusion`: Определяют конкретные границы окна.

Оконные функции являются важным инструментом для аналитических запросов, позволяя выполнять сложные вычисления и анализ данных в рамках SQL.

# Применение оконных функций

Оконные функции в SQL особенно полезны в ситуациях, когда требуется проводить анализ данных на основе некоторого контекста или окна, а не только на основе всей выборки данных. Вот несколько примеров задач, где оконные функции незаменимы:

1. **Ранг элементов**: Представьте, что у вас есть таблица продаж, и вы хотите определить ранг каждого продавца по объему продаж за месяц. Без оконных функций вам пришлось бы создавать временные таблицы или использовать сложные соединения. С оконными функциями это можно сделать одним запросом, используя функцию `RANK()`:

```SQL
SELECT seller_id, sales_volume, RANK() OVER (ORDER BY sales_volume DESC) as sales_rank
FROM sales_table
WHERE sales_month = '2023-01';
```

1. **Смещение данных во времени**: Если вы анализируете временные ряды данных и хотите сравнить текущие показатели с предыдущими или последующими периодами, оконные функции `LAG()` и `LEAD()` становятся незаменимыми:

```SQL
SELECT date, sales, LAG(sales, 1) OVER (ORDER BY date) as previous_day_sales
FROM daily_sales;
```

1. **Суммирование части набора данных**: Предположим, вы хотите вычислить скользящее среднее значение продаж за последние 7 дней. Оконные функции позволяют легко определить окно в 7 дней и вычислить среднее значение:

```SQL
SELECT date, sales, AVG(sales) OVER (ORDER BY date ROWS BETWEEN 6 PRECEDING AND CURRENT ROW) as moving_average
FROM daily_sales;
```

1. **Анализ по группам**: Если у вас есть данные о продажах по регионам и вы хотите узнать, какой процент от общего объема продаж в регионе составляет каждая продажа, оконные функции помогут вычислить процентные соотношения:

```SQL
SELECT region, sale_id, sale_amount,
       (sale_amount / SUM(sale_amount) OVER (PARTITION BY region)) * 100 as percentage_of_region_sales
FROM sales_table;
```

1. **Анализ трендов**: Когда необходимо определить, как изменяются показатели (например, цены) с течением времени, оконные функции позволяют вычислить разницу между текущим значением и средним значением за предыдущий период:

```SQL
SELECT date, price,
       price - AVG(price) OVER (ORDER BY date ROWS BETWEEN 30 PRECEDING AND 1 PRECEDING) as price_trend
FROM stock_prices;
```

В этих примерах оконные функции позволяют выполнять сложные аналитические вычисления непосредственно в запросе SQL, что упрощает анализ данных и повышает эффективность работы с большими объемами информации.