## **Что это такое?**
Это инструмент, который позволяет сделать из JSON — таблицу в формате CSV, и получить ссылку для скачивания данной таблицы.
Инструмент может оказаться полезным в том случае, если, например, у пользователя есть необходимость получать таблицу в csv формате прямо из дашборда на почту, либо в telegram клиент. 
При этом, из-за того, что мы отправляем, фактически, не сам файл, а ссылку на него, этот файл может быть передан куда-угодно.

## **Как им пользоваться?**
Для того, чтобы воспользоваться данным инструментом, нужно настроить блок пользовательских интеграций. _На сколько я знаю, он доступен только на версиях Processet на образах_.
Далее будут представлены все шаги к конвертации полученного текста (_вывода_) в таблицу в формате csv.

![[Цепочка выполнения конвертации в csv.png]]

1. Подготовка данных, и перевод их в JSON:
   В целом, это не так сложно. Вся задача состоит в том, чтобы нужный нам вывод обернуть в json форматирование и передать дальше. Я использую такой код:
   
```SQL
select
   groupArray(data) as json_data
   
from ( 
   select 
	   toJSONString(
		   map(
			   'key1', toString(field1),
			   'key2', toString(avg(field2)),
			   'key3', toString(sum(field3))
		   )
	   ) as data
	from test_table
	group by field1
	order by field3
	limit 10
)
```


 >Для того, чтобы не возникало ошибок советую оборачивать весь  вывод в _toString()_. Это нужно для того, чтобы не было ошибки "Разного типа данных"
 
 Как можно заметить, логика построения запроса может быть абсолютно любой, главное - получить на выходе плоский JSON вывод.

 2. Полученный JSON вывод нужно передать в блок пользовательской интеграции, который переработает этот JSON таким образом, чтобы на выходе получился CSV-подобный текст.
 Название блока **Блок получения данных**
  
3. Полученный из предыдущего блока вывод, в виде csv-подобного текста нужно передать в следующий блок, который называется "_Загрузить данные на сервис_". 
   
4. Под капотом в этом блоке выполняется HTTP POST запрос на API сервиса "https://konbert.com/convert", где в теле запроса передаются такие параметры, как:
	* что мы собираемся превратить в csv;
	* разделитель в передаваемом тексте;
	* разделитель в будущей csv таблице.
	
Данный блок возвращает некий _file_id_. Этот параметр нужен для того, чтобы передать его в дальнейшие блоки, так как он нужен для дальнейшего вычисления на стороне сервиса. 

5. Полученный _file_id_ передаем в блок, который называется "_Конвертировать данные_".  Целью выполнения данного блока является получение _output_file_id_. По капотом именно это и выполняется.
6. Необходимо поставить паузу в несколько секунд. В моем случае достаточно 3-х, чтобы  сервер обработал все, что мы ему передали.
   Это делается с помощью SQL блока. Код выглядит так:
```SQL
select sleep(3) as slp
```

7. Выполняем блок "_Вернуть ссылку на файл_". На вход подается полученный ранее _output_file_id_, а на выходе готовую ссылку для скачивания.
8. Далее формируем сообщение, какое хотим и передаем любым удобным для нас способом. Я же отправляю сообщение в Telegram. При этом ссылка живет довольно продолжительное количество времени.


   